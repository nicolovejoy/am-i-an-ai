<!DOCTYPE html>
<html>
<head>
    <title>AmIAnAI v2 WebSocket Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; }
        .system { color: #666; }
        .sent { color: #0066cc; }
        .received { color: #009900; }
        input { width: 300px; }
    </style>
</head>
<body>
    <h1>AmIAnAI v2 WebSocket Test</h1>
    <div id="status">Disconnected</div>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." disabled>
    <button id="sendBtn" disabled>Send</button>
    <button id="connectBtn">Connect</button>

    <script>
        const wsUrl = 'wss://i5csamj3a8.execute-api.us-east-1.amazonaws.com/prod';
        let ws = null;

        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const connectBtn = document.getElementById('connectBtn');

        function log(message, className = 'system') {
            const div = document.createElement('div');
            div.className = 'message ' + className;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function connect() {
            if (ws) {
                ws.close();
            }

            log('Connecting to ' + wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('Connected! Sending join request...');
                status.textContent = 'Connected';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                connectBtn.textContent = 'Disconnect';
                
                // Send a join message to get our identity
                ws.send(JSON.stringify({
                    action: 'join'
                }));
            };

            ws.onmessage = (event) => {
                log('Received: ' + event.data, 'received');
                try {
                    const data = JSON.parse(event.data);
                    if (data.identity) {
                        status.textContent = 'Connected as ' + data.identity;
                    }
                } catch (e) {
                    // Not JSON, that's ok
                }
            };

            ws.onerror = (error) => {
                log('Error: ' + error, 'error');
            };

            ws.onclose = () => {
                log('Disconnected');
                status.textContent = 'Disconnected';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                connectBtn.textContent = 'Connect';
            };
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                const payload = JSON.stringify({
                    action: 'message',
                    content: message
                });
                ws.send(payload);
                log('Sent: ' + payload, 'sent');
                messageInput.value = '';
            }
        }

        connectBtn.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connect();
            }
        };

        sendBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        };
    </script>
</body>
</html>